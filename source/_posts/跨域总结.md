---
title: 跨域总结
date: 2018-11-20 16:00
categories:
- 请求
tags:
- XMLHttoRequest
- Fetch
toc:
---

  面试时经常会被问到跨域问题，因此，在此做个详细的总结

<!-- more -->

# 跨域总结

## 为什么会出现跨域问题

* 出于浏览器同源策略限制，浏览器会拒绝跨域的读操作请求。
* 同源策略是一个用于隔离潜在恶意文件的重要安全机制。
* 同源的定义： 如果两个页面的协议、端口、域名都相同，则同源。非同源请求，均为跨域

## 如何实现跨域

  最常用的跨域方式有以下四种：**JSONP、 CORS、 postMessage、 WebSocket**

### 一、JSONP

**JSONP是一种比较hack的方式，单纯的为了实现跨域请求而创造的一个trick.**

JSONP的核心是动态添加< script >标签来调用服务器提供的js脚本。ajax的核心是通过XMLHttpRequest获取非本页内容。

#### 优缺点

* 优点： 兼容性好，能兼容到低版本IE
* 缺点： 1.JSONP只支持GET请求；2.XMLHttpRequest相对于JSONP有着更好的错误处理机制 

#### 实现方式（需前后端配合）

原理： < script >标签的src属性是可以跨域的。传递一个`callback`参数给跨域服务端，返回数据时将这个`callback`参数作为函数名包裹要返回的json数据。

* 前端

```javascript
<script type="type/javascript">
  // 回调函数
  function doSomething(data) {
    // 处理获得的数据
    ...
  }

  // 请求
  // 第一种做法：<script src="http://example.com/data.php?callback=doSomething"></script>
  // 第二种做法
  var url = "http://example.com/data.php?callback=doSomething";
  var script = document.createElement('script');
  script.setAttribute('src', url);
  document.getElementsByTagName('head')[0].appendChild(script);
</script>
```

* 后端

```php
<?php
  $callback = $_GET['callback']; // 得到回调函数名
  $data = array('a', 'b', 'c');  // 要返回的数据
  echo $callback.'('.json_encode($data).')'; // 输出回前端
>
```

### 二、CORS（跨域资源共享 cross-origin sharing standard）

* CORS 是W3C推荐的一种新的官方方案，能使服务器支XMLHttpRequest的跨域请求。
* CORS实现起来非常方便，只需增加一些HTTP头，让服务器能声明允许的访问来源。
* 通常使用CORS时，异步请求会被分为简单请求和非简单请求，区别是，非简单请求会先使用`OPTIONS`方法发起一个预检请求(`prefight request`)，获知服务端是否允许跨域请求

#### 简单请求

满足以下条件的可视为简单请求：

* Method 为 `GET` 、`HEAD` 、`POST`之一
* Fetch 规定了对CORS安全的首部字段集合，如人为设定了集合之外的其他首部字段，则就不是简单请求了。集合如下
  * Accept
  * Accept-Language
  * Content-Language
  * Content-Type 的值仅限于 `text/plain`、`multipart/form-data`、`application/x-www-form-urlencoded`
  * DPR
  * Downlink
  * Save-Data
  * Viewport-Width
  * Width
* 请求中的任意`XMLHttpRequestUpload`对象均没有注册任何时间监听器
* 请求中没有使用`ReadableStream`对象

##### 请求、响应头部的特点

请求头部需带上`Origin：[originURL]`

服务端响应会携带首部字段``

